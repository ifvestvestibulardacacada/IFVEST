<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <title>Template Geração PDF - IFVest Estilo ENEM</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
   
    <link rel="stylesheet" href="/simulados/css/prova/templateprova.css">


</head>
<body>

<%

    function parseRichText(jsonString) {
        if (!jsonString) return '';
        let html = '';
        try {
            const ops = JSON.parse(jsonString).ops;
            
            ops.forEach(op => {
                
                // 1. É um objeto de IMAGEM?
                if (op.insert && typeof op.insert === 'object' && op.insert.image) {
                    let attrs = op.attributes || {};
                    let style = 'max-width: 100%; height: auto; display: block; margin: 10px 0; border: 1px solid #ccc;';
                    
                    // Se o JSON tiver uma largura específica, usa, mas mantém responsivo
                    if (attrs.width) {
                        style = `width: ${attrs.width}px; max-width: 100%; height: auto; display: block; margin: 10px 0; border: 1px solid #ccc;`;
                    }
                    html += `<img src="${op.insert.image}" alt="Imagem da questão" style="${style}">`;
                }
                
                // 2. É um TEXTO?
                else if (op.insert && typeof op.insert === 'string') {
                    let text = op.insert;
                    
                    // Limpa qualquer artefato de imagem em markdown (ex: ![](...))
                    // já que a imagem real vem do objeto acima.
                    text = text.replace(/!\[.*?\]\(.*?\)/g, ''); 
                    
                    // Aplica formatação de negrito e quebras de linha
                    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
                    text = text.replace(/\n/g, '<br>'); 
                    
                    html += text;
                }
            });

        } catch (e) {
            console.error("Erro ao parsear JSON:", e, jsonString);
            return jsonString; // Retorna a string original em caso de erro
        }
        return html;
    }
%>


    <div id="simulado-print-area" class="page-container">

        <div class="controls">
            <button id="printButton">Imprimir Simulado</button>
            <button id="toggleAnswersButton">Mostrar/Ocultar Gabarito</button>
        </div>

        <header class="exam-header">
            <h1><%= simulado.titulo %></h1>
            <p><%= simulado.descricao %></p>
        </header>

        <main class="content-area">

            <% simulado.Questao.forEach((questao, index) => { %>
            
                <article class="question">
                    
                    <p class="question-text">
                        <%= questao.titulo || `Questão ${index + 1}` %>
                    </p>
                    
                    <div class="question-body">
                        <%# A função parseRichText agora renderiza o HTML correto %>
                        <%- parseRichText(questao.pergunta) %>
                    </div>

                    <ol class="alternatives">
                        
                        <% questao.Opcao.forEach(opcao => { %>
                        
                            <li data-answer="<%= opcao.correta %>">
                                <%- parseRichText(opcao.descricao) %>
                            </li>
                        
                        <% }) %>
                    </ol>
                </article>

            <% }) %>
            
        </main> 
        </div> 
        <script>
        // O JavaScript original para os botões permanece IDÊNTICO.
        document.addEventListener('DOMContentLoaded', function() {
            
            const printButton = document.getElementById('printButton');
            if (printButton) {
                printButton.addEventListener('click', function() {
                    window.print();
                });
            }

            const toggleAnswersButton = document.getElementById('toggleAnswersButton');
            if (toggleAnswersButton) {
                toggleAnswersButton.addEventListener('click', function() {
                    document.body.classList.toggle('show-answers');
                });
            }
        });
    </script>

</body>
</html>