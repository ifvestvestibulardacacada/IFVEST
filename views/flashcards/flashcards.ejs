<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IFVest - Flashcards</title>
    <link rel="stylesheet" href="/css/flashcards/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
  </head>
  <body data-id-usuario="<%= id_usuario %>">
  <%- include('../partials/header') %>
  <div class="container">
      <%- include('../partials/sidebar') %>
  <main class="flashcard-content">
        <!-- Left column: Groups -->
  <aside class="flashcard-groups">
          <h3 class="group-heading">Revisão por tempo visto</h3>
          <div class="group-list">
            <% if (groups) { %>
              <% let totalCount = 0; Object.values(groups).forEach(arr => totalCount += arr.length); %>
              <div class="group-block">
                <div class="group-header">
                  <div class="group-title">Misto recomendado</div>
                  <% if (totalCount === 0) { %>
                    <a class="group-action disabled">Revisar</a>
                  <% } else { %>
                    <a class="group-action" href="/flashcards?<%=
                      [
                        id_area ? `id_area=${id_area}` : null,
                        id_topico ? `id_topico=${id_topico}` : null,
                        id_dificuldade ? `id_dificuldade=${id_dificuldade}` : null,
                        'grupo=misto'
                      ].filter(Boolean).join('&')
                    %>">Revisar</a>
                  <% } %>
                </div>
              </div>
              <% Object.entries(groups).forEach(([days, cards]) => { %>
                <div class="group-block <%= selectedGroup === days ? 'active' : '' %>">
                  <div class="group-header">
                    <div class="group-title">
                      <%= days === '1' ? 'Vistos hoje' : days === '3' ? 'Vistos há 3 dias' : days === '7' ? 'Vistos há 7 dias' : 'Vistos há 15+ dias' %>
                      (<%= cards.length %>)
                    </div>
                    <% if (cards.length === 0) { %>
                      <a class="group-action disabled">Revisar</a>
                    <% } else { %>
                      <a class="group-action" href="/flashcards?<%=
                        [
                          id_area ? `id_area=${id_area}` : null,
                          id_topico ? `id_topico=${id_topico}` : null,
                          id_dificuldade ? `id_dificuldade=${id_dificuldade}` : null,
                          `grupo=${days}`
                        ].filter(Boolean).join('&')
                      %>">Revisar</a>
                    <% } %>
                  </div>
                  <% if (cards.length > 0) { %>
                    <ul class="group-cards">
                      <% cards.slice(0,5).forEach(card => { %>
                        <li>
                          <span>
                            <%= card.pergunta.length > 40 ? card.pergunta.slice(0, 40) + '...' : card.pergunta %>
                          </span>
                        </li>
                      <% }) %>
                      <% if (cards.length > 5) { %>
                        <li>...</li>
                      <% } %>
                    </ul>
                  <% } else { %>
                    <span class="no-flashcard">Nenhum flashcard</span>
                  <% } %>
                </div>
              <% }) %>
            <% } %>
          </div>
        </aside>
        <!-- Right column: Flashcards -->
  <section class="flashcard-section">
          <%- include('../partials/flashcardFiltros') %>
          <div class="queue-label">
            <% if (selectedGroup === 'misto') { %>
              Revisando: Misto recomendado
            <% } else if (selectedGroup === '1') { %>
              Revisando: Vistos hoje
            <% } else if (selectedGroup === '3') { %>
              Revisando: Vistos há 3 dias
            <% } else if (selectedGroup === '7') { %>
              Revisando: Vistos há 7 dias
            <% } else if (selectedGroup === '15+') { %>
              Revisando: Vistos há 15+ dias
            <% } else { %>
              Revisando: Não vistos (aleatório)
            <% } %>
          </div>
          <div id="flashcard-container">
            <% 
              // Prefer server-side displayFlashcards (group or mixed selection)
              let unseen = unseenFlashcards || [];
              let display = (typeof displayFlashcards !== 'undefined' && displayFlashcards && displayFlashcards.length > 0) ? displayFlashcards : unseen.slice(0, 10);
            %>
            <% if (display.length > 0) { %>
              <% display.forEach((card, index) => { %>
                <!-- Adiciona a classe 'active' apenas no primeiro card -->
                <div class="flashcard <%= index === 0 ? 'active' : '' %>" data-index="<%= index %>" data-id-flashcard="<%= card.id_flashcards %>">
                  <div class="flashcard-inner">
                    <div class="flashcard-front">
                      <p class="pergunta"><%= card.pergunta %></p>
                      <button class="ver-resposta">Ver resposta</button>
                      <div class="interrogacao">?</div>
                    </div>
                    <div class="flashcard-back">
                      <p class="resposta"><%= card.resposta %></p>
                      <button class="ver-pergunta">Ver pergunta</button>
                    </div>
                  </div>
                </div>
              <% }) %>
            <% } else { %>
              <p>Nenhum flashcard encontrado para o filtro selecionado.</p>
            <% } %>
          </div>
          <!-- Controles de Navegação -->
          <% if (display && display.length > 0) { %>
            <div class="navigation-controls">
              <button id="prev-btn" class="nav-btn"><i class="fas fa-chevron-left"></i> Anterior</button>
              <span id="progress-indicator">1 / <%= display.length %></span>
              <button id="next-btn" class="nav-btn">Próximo <i class="fas fa-chevron-right"></i></button>
            </div>
          <% } %>
        </section>
      </main>
    </div>

  <script src="/js/flashcard/navegaFlashcards.js"></script>
  </body>
</html>